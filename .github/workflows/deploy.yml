name: Deploy (self-hosted)

on:
  workflow_run:
    workflows: ["CI"]
    branches: ["main"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-main
  cancel-in-progress: false

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, Linux, X64, roehub, prod]
    timeout-minutes: 20

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Show context
        run: |
          whoami
          id
          docker --version
          docker compose version
          command -v rsync || true

      - name: Assert server prerequisites
        run: |
          set -euxo pipefail
          test -s /etc/roehub/roehub.env
          test -d /opt/roehub
          test -w /opt/roehub

      - name: Sync deploy bundle to /opt/roehub
        run: |
          set -euxo pipefail

          # ensure target dirs exist
          install -d /opt/roehub
          install -d /opt/roehub/monitoring
          install -d /opt/roehub/market-data-src
          install -d /opt/roehub/market-data-src/infra

          # 1) main compose -> /opt/roehub/docker-compose.yml
          install -m 0644 infra/docker/docker-compose.yml /opt/roehub/docker-compose.yml
          # 2) market-data compose -> /opt/roehub/docker-compose.market_data.yml
          install -m 0644 infra/docker/docker-compose.market_data.yml /opt/roehub/docker-compose.market_data.yml

          # 3) market-data build context -> /opt/roehub/market-data-src/
          if command -v rsync >/dev/null 2>&1; then
            rsync -a --delete src/ /opt/roehub/market-data-src/src/
            rsync -a --delete apps/ /opt/roehub/market-data-src/apps/
            rsync -a --delete configs/ /opt/roehub/market-data-src/configs/
            rsync -a --delete infra/docker/ /opt/roehub/market-data-src/infra/docker/
          else
            rm -rf /opt/roehub/market-data-src/src /opt/roehub/market-data-src/apps /opt/roehub/market-data-src/configs /opt/roehub/market-data-src/infra/docker
            install -d /opt/roehub/market-data-src/src
            install -d /opt/roehub/market-data-src/apps
            install -d /opt/roehub/market-data-src/configs
            install -d /opt/roehub/market-data-src/infra/docker
            tar -C src -cf - . | tar -C /opt/roehub/market-data-src/src -xf -
            tar -C apps -cf - . | tar -C /opt/roehub/market-data-src/apps -xf -
            tar -C configs -cf - . | tar -C /opt/roehub/market-data-src/configs -xf -
            tar -C infra/docker -cf - . | tar -C /opt/roehub/market-data-src/infra/docker -xf -
          fi
          install -m 0644 pyproject.toml /opt/roehub/market-data-src/pyproject.toml

          # 4) monitoring -> /opt/roehub/monitoring/
          if command -v rsync >/dev/null 2>&1; then
            rsync -a --delete infra/monitoring/monitoring/ /opt/roehub/monitoring/
          else
            rm -rf /opt/roehub/monitoring/*
            tar -C infra/monitoring/monitoring -cf - . | tar -C /opt/roehub/monitoring -xf -
          fi

          # checks
          test -s /opt/roehub/docker-compose.yml
          test -s /opt/roehub/docker-compose.market_data.yml
          test -s /opt/roehub/market-data-src/pyproject.toml
          test -s /opt/roehub/market-data-src/infra/docker/Dockerfile.market_data
          test -s /opt/roehub/monitoring/prometheus/prometheus.yml
          test -s /opt/roehub/monitoring/blackbox/blackbox.yml
          ls -la /opt/roehub | head -n 50

      - name: Ensure external Docker volumes
        run: |
          set -euxo pipefail
          docker volume inspect grafana_data >/dev/null 2>&1 || docker volume create grafana_data

      - name: Validate compose files
        run: |
          set -euxo pipefail
          docker compose -f /opt/roehub/docker-compose.yml --env-file /etc/roehub/roehub.env config >/dev/null
          docker compose -f /opt/roehub/docker-compose.market_data.yml --env-file /etc/roehub/roehub.env config >/dev/null

      - name: Deploy main stack via Docker Compose
        env:
          COMPOSE_PROJECT_NAME: roehub
        run: |
          set -euxo pipefail
          docker compose -f /opt/roehub/docker-compose.yml --env-file /etc/roehub/roehub.env pull postgres clickhouse grafana prometheus blackbox
          docker compose -f /opt/roehub/docker-compose.yml --env-file /etc/roehub/roehub.env up -d --remove-orphans
          docker compose -f /opt/roehub/docker-compose.yml --env-file /etc/roehub/roehub.env ps

      - name: Deploy market-data stack via Docker Compose
        env:
          COMPOSE_PROJECT_NAME: roehub-market-data
          MARKET_DATA_BUILD_CONTEXT: /opt/roehub/market-data-src
          MARKET_DATA_DOCKERFILE: infra/docker/Dockerfile.market_data
        run: |
          set -euxo pipefail
          docker compose -f /opt/roehub/docker-compose.market_data.yml --env-file /etc/roehub/roehub.env up -d --build --remove-orphans
          docker compose -f /opt/roehub/docker-compose.market_data.yml --env-file /etc/roehub/roehub.env ps
