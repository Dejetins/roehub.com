services:
  # api:
  #   image: roehub-api
  #   container_name: roehub-api-1
  #   restart: unless-stopped
  #   ports:
  #     - "0.0.0.0:8000:8000"
  #   env_file:
  #     - /etc/roehub/roehub.env
  #   depends_on:
  #     - postgres
  #     - clickhouse
  #   command: uvicorn app.main:app --host 0.0.0.0 --port 8000

  postgres:
    image: postgres:16
    container_name: roehub-postgres-1
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-roehub}
      POSTGRES_USER: ${POSTGRES_USER:-roehub}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "127.0.0.1:${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-roehub} -d ${POSTGRES_DB:-roehub}"]
      interval: 5s
      timeout: 5s
      retries: 20
    volumes:
      - pg_data:/var/lib/postgresql/data

  clickhouse:
    image: clickhouse/clickhouse-server:24.8
    container_name: roehub-clickhouse-1
    restart: unless-stopped
    ports:
      - "127.0.0.1:8123:8123"
      - "127.0.0.1:9000:9000"
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    environment:
      CLICKHOUSE_DB: ${CLICKHOUSE_DB:-roehub}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-roe}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD}
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: "1"
    volumes:
      - ch_data:/var/lib/clickhouse
      - ch_logs:/var/log/clickhouse-server

  redis:
    image: redis:7.2-bookworm
    container_name: redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data

  db-bootstrap:
    profiles: ["ui"]
    build:
      context: ${MARKET_DATA_BUILD_CONTEXT:-../..}
      dockerfile: ${MARKET_DATA_DOCKERFILE:-infra/docker/Dockerfile.market_data}
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"
    environment:
      IDENTITY_PG_DSN: "host=postgres port=5432 dbname=${POSTGRES_DB:-roehub} user=${POSTGRES_USER:-roehub} password=${POSTGRES_PASSWORD}"
      POSTGRES_DSN: "host=postgres port=5432 dbname=${POSTGRES_DB:-roehub} user=${POSTGRES_USER:-roehub} password=${POSTGRES_PASSWORD}"
    command:
      - python
      - -m
      - apps.migrations.bootstrap_main

  api:
    profiles: ["ui"]
    build:
      context: ${MARKET_DATA_BUILD_CONTEXT:-../..}
      dockerfile: ${MARKET_DATA_DOCKERFILE:-infra/docker/Dockerfile.market_data}
    depends_on:
      clickhouse:
        condition: service_started
      redis:
        condition: service_started
      db-bootstrap:
        condition: service_completed_successfully
    environment:
      ROEHUB_ENV: ${ROEHUB_ENV:-dev}
      ROEHUB_NUMBA_NUM_THREADS: ${ROEHUB_NUMBA_NUM_THREADS:-4}
      NUMBA_NUM_THREADS: ${ROEHUB_NUMBA_NUM_THREADS:-4}
      IDENTITY_FAIL_FAST: ${IDENTITY_FAIL_FAST:-false}
      STRATEGY_FAIL_FAST: ${STRATEGY_FAIL_FAST:-false}
      BACKTEST_FAIL_FAST: ${BACKTEST_FAIL_FAST:-false}
      IDENTITY_PG_DSN: "host=postgres port=5432 dbname=${POSTGRES_DB:-roehub} user=${POSTGRES_USER:-roehub} password=${POSTGRES_PASSWORD}"
      STRATEGY_PG_DSN: "host=postgres port=5432 dbname=${POSTGRES_DB:-roehub} user=${POSTGRES_USER:-roehub} password=${POSTGRES_PASSWORD}"
      CH_HOST: ${CH_HOST:-clickhouse}
      CH_PORT: ${CH_PORT:-8123}
      CH_DATABASE: ${CH_DATABASE:-market_data}
      CH_USER: ${CH_USER:-default}
      CH_PASSWORD: ${CH_PASSWORD:-}
      CH_SECURE: ${CH_SECURE:-0}
      CH_VERIFY: ${CH_VERIFY:-1}
      ROEHUB_REDIS_PASSWORD: ${ROEHUB_REDIS_PASSWORD:-}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
    command:
      - python
      - -m
      - apps.api.main.main
      - --host
      - 0.0.0.0
      - --port
      - "8000"
    expose:
      - "8000"

  web:
    profiles: ["ui"]
    build:
      context: ${MARKET_DATA_BUILD_CONTEXT:-../..}
      dockerfile: ${MARKET_DATA_DOCKERFILE:-infra/docker/Dockerfile.market_data}
    depends_on:
      api:
        condition: service_started
    environment:
      WEB_API_BASE_URL: ${WEB_API_BASE_URL:-http://gateway}
    command:
      - python
      - -m
      - apps.web.main.main
      - --host
      - 0.0.0.0
      - --port
      - "8010"
    expose:
      - "8010"

  gateway:
    profiles: ["ui"]
    build:
      context: ${MARKET_DATA_BUILD_CONTEXT:-../..}
      dockerfile: infra/docker/Dockerfile.gateway
    depends_on:
      api:
        condition: service_started
      web:
        condition: service_started
    expose:
      - "80"
    ports:
      - "${GATEWAY_HOST_BIND:-127.0.0.1}:${GATEWAY_HOST_PORT:-8080}:80"

  market-data-ws-worker:
    build:
      context: ${MARKET_DATA_BUILD_CONTEXT:-../..}
      dockerfile: ${MARKET_DATA_DOCKERFILE:-infra/docker/Dockerfile.market_data}
    restart: unless-stopped
    depends_on:
      - clickhouse
      - redis
    environment:
      CH_HOST: clickhouse
      CH_PORT: 8123
      CH_DATABASE: ${CH_DATABASE:-market_data}
      CH_USER: ${CLICKHOUSE_USER:-default}
      CH_PASSWORD: ${CLICKHOUSE_PASSWORD:-}
      CH_SECURE: "0"
      CH_VERIFY: "1"
      ROEHUB_REDIS_PASSWORD: ${ROEHUB_REDIS_PASSWORD:-}
    command:
      - python
      - -m
      - apps.worker.market_data_ws.main.main
      - --config
      - /app/configs/prod/market_data.yaml
      - --metrics-port
      - "9201"
    expose:
      - "9201"

  market-data-scheduler:
    build:
      context: ${MARKET_DATA_BUILD_CONTEXT:-../..}
      dockerfile: ${MARKET_DATA_DOCKERFILE:-infra/docker/Dockerfile.market_data}
    restart: unless-stopped
    depends_on:
      - clickhouse
    environment:
      CH_HOST: clickhouse
      CH_PORT: 8123
      CH_DATABASE: ${CH_DATABASE:-market_data}
      CH_USER: ${CLICKHOUSE_USER:-default}
      CH_PASSWORD: ${CLICKHOUSE_PASSWORD:-}
      CH_SECURE: "0"
      CH_VERIFY: "1"
    command:
      - python
      - -m
      - apps.scheduler.market_data_scheduler.main.main
      - --config
      - /app/configs/prod/market_data.yaml
      - --whitelist
      - /app/configs/prod/whitelist.csv
      - --metrics-port
      - "9202"
    expose:
      - "9202"

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "127.0.0.1:${GRAFANA_PORT:-3000}:3000"
    environment:
      GF_SERVER_ROOT_URL: ${GF_SERVER_ROOT_URL}
    volumes:
      - grafana_data:/var/lib/grafana

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "127.0.0.1:9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prom_data:/prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--storage.tsdb.retention.time=90d"

  blackbox:
    image: prom/blackbox-exporter:latest
    container_name: blackbox
    restart: unless-stopped
    ports:
      - "127.0.0.1:9115:9115"
    volumes:
      - ./monitoring/blackbox/blackbox.yml:/etc/blackbox_exporter/config.yml:ro
    command:
      - "--config.file=/etc/blackbox_exporter/config.yml"

volumes:
  pg_data: {}
  ch_data: {}
  ch_logs: {}
  redis_data: {}
  prom_data: {}
  grafana_data:
    external: true
