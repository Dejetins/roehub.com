version: 1

market_data:
  markets:
    # 1) Binance Spot
    - market_id: 1
      exchange: binance
      market_type: spot
      market_code: binance:spot
      rest:
        base_url: "https://api.binance.com"
        earliest_available_ts_utc: "2017-01-01T00:00:00Z"
        timeout_s: 10.0
        retries: 3
        backoff: { base_s: 0.5, max_s: 10.0, jitter_s: 0.2 }
        limiter: { mode: autodetect, safety_factor: 0.8, max_concurrency: 4 }
      ws:
        # Combined streams endpoint: /stream?streams=...
        url: "wss://stream.binance.com:9443/stream"
        ping_interval_s: 20.0
        pong_timeout_s: 10.0
        reconnect: { min_delay_s: 0.5, max_delay_s: 30.0, factor: 1.7, jitter_s: 0.2 }
        max_symbols_per_connection: 200

    # 2) Binance Futures (USD-M)
    - market_id: 2
      exchange: binance
      market_type: futures
      market_code: binance:futures
      rest:
        base_url: "https://fapi.binance.com"
        earliest_available_ts_utc: "2019-09-01T00:00:00Z"
        timeout_s: 10.0
        retries: 3
        backoff: { base_s: 0.5, max_s: 10.0, jitter_s: 0.2 }
        limiter: { mode: autodetect, safety_factor: 0.8, max_concurrency: 4 }
      ws:
        # Combined streams endpoint: /stream?streams=...
        url: "wss://fstream.binance.com/stream"
        ping_interval_s: 20.0
        pong_timeout_s: 10.0
        reconnect: { min_delay_s: 0.5, max_delay_s: 30.0, factor: 1.7, jitter_s: 0.2 }
        max_symbols_per_connection: 200

    # 3) Bybit Spot (V5)
    - market_id: 3
      exchange: bybit
      market_type: spot
      market_code: bybit:spot
      rest:
        base_url: "https://api.bybit.com"
        earliest_available_ts_utc: "2018-01-01T00:00:00Z"
        timeout_s: 10.0
        retries: 3
        backoff: { base_s: 0.5, max_s: 10.0, jitter_s: 0.2 }
        limiter: { mode: autodetect, safety_factor: 0.8, max_concurrency: 4 }
      ws:
        url: "wss://stream.bybit.com/v5/public/spot"
        ping_interval_s: 20.0
        pong_timeout_s: 10.0
        reconnect: { min_delay_s: 0.5, max_delay_s: 30.0, factor: 1.7, jitter_s: 0.2 }
        # bybit spot подписки имеют ограничения по args, но это уже в адаптере;
        # здесь просто операционное ограничение для вашего разбиения на коннекты
        max_symbols_per_connection: 10

    # 4) Bybit Futures (V5 linear: USDT perpetual & futures)
    - market_id: 4
      exchange: bybit
      market_type: futures
      market_code: bybit:futures
      rest:
        base_url: "https://api.bybit.com"
        earliest_available_ts_utc: "2018-01-01T00:00:00Z"
        timeout_s: 10.0
        retries: 3
        backoff: { base_s: 0.5, max_s: 10.0, jitter_s: 0.2 }
        limiter: { mode: autodetect, safety_factor: 0.8, max_concurrency: 4 }
      ws:
        url: "wss://stream.bybit.com/v5/public/linear"
        ping_interval_s: 20.0
        pong_timeout_s: 10.0
        reconnect: { min_delay_s: 0.5, max_delay_s: 30.0, factor: 1.7, jitter_s: 0.2 }
        max_symbols_per_connection: 200

  ingestion:
    # SLO: <=1s до raw (лучше 0.5s) -> держим 250ms как дефолт
    flush_interval_ms: 250
    max_buffer_rows: 2000
    rest_concurrency_instruments: 4
    tail_lookback_minutes: 180
    rest_inter_instrument_delay_s: 2.0

  live_feed:
    redis_streams:
      enabled: true
      host: "redis"
      port: 6379
      db: 0
      password_env: "ROEHUB_REDIS_PASSWORD"
      socket_timeout_s: 2.0
      connect_timeout_s: 2.0
      stream_mode: "per_instrument"
      stream_prefix: "md.candles.1m"
      retention_days: 7

  scheduler:
    jobs:
      sync_whitelist:
        interval_seconds: 900
      enrich:
        interval_seconds: 21600
      rest_insurance_catchup:
        interval_seconds: 3600

  backfill:
    max_days_per_insert: 7
    chunk_align: "utc_day"
